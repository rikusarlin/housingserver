# housingserver
Spring Boot Rest service, with validations done using Spring Validation and ORM stuff done with Spring Data repository backed by H2 database or PostgreSQL. The actual Rest service is generated by openapi-generator from an OpenApi 3.0 specification. 

## Domain model
The application domain is an imaginary "housing benefit application" containing various pieces of information. Date periods and of money of many are prominent features in this domain model. The business objects are as follows
* Housing benefit case
    * id
    * case state
    * Customer
            * id
            * person number
            * date of birth
            * first name
            * last name    
            * gender
            * email
    * Housing benefit application
        * id
        * date range of application
        * timestamp when received
        * Applicant
            * id
            * person number
            * date of birth
            * first name
            * last name
            * gender
            * email
    * List of household members 
        * id
        * date range
        * Person
            * id
            * person number
            * date of birth
            * first name
            * last name
            * gender
            * email
    * List of incomes
        * id
        * income type
        * description, if type of income is "other income"
        * amount
        * date range
    * List of housing expenses
        * id
        * expense type
        * description, if type of expense is "other expense"
        * amount
        * date range

In addition, basic auditing info (creation and modification timestamp, creator and modifier) is present in all tables.

## Technologies used
The application uses various technologies, as follows:
* Spring Boot: the basic framework tying it all together
* H2 database: simple embedded database, in this case used in a file-based manner
* openapi-generator: generates Rest API implementation and Rest API transfer objects
* ModelMapper: mapping between (generated) Rest API transfer objects and Entity classes
* Hibernate: object-relational mapping
* Spring Validation: entity validation
* Liquibase: database change control
* fabric8: running in OpenShift

## Local use
The service is accessed via Rest api. Swagger UI is included in the package in the following address: 
http://localhost:8080/swagger-ui.html

If H2 database is used, its UI can be accessed via the following address:
http://localhost:8080/h2

Database URL for H2 is "jdbc:h2:file:./testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE", username is "sa" and password is empty (!).

## API functions

### Housing benefit case
* GET /api/v2/housing/cases - fetch all housing benefit cases
* GET /api/v2/housing/cases/person/{personNumber} - fetch all housing benefit cases where a person given is a member of household
* GET /api/v2/housing/cases/{caseId} - fetch one housing benefit case
* PUT /api/v2/housing/cases/{caseId} - update housing benefit case
* POST /api/v2/housing/cases - add housing benefit case
* GET /api/v2/housing/cases/{caseId}/check - cross validate housing benefit application

### Persons
These are considered to be stored in a separate database, reflected in the fact they are accessed through api in another "context root", and not needing a case id
* GET /api/v2/housing/persons - fetch all persons
* GET /api/v2/housing/persons/{id} - fetch one person
* PUT /api/v2/housing/persons - add person
* POST /api/v2/housing/persons/{id} - update person
* GET /api/v2/housing/persons/{id}/check - cross validate person
 
### Household member
* GET /api/v2/housing/householdmembers/{caseId} - fetch all household members of a case
* GET /api/v2/housing/householdmembers/{caseId}/{id} - fetch one household member of a case
* PUT /api/v2/housing/householdmembers/{caseId} - add household member to a case, a Household member containing a Person needs to be in payload
* POST /api/v2/housing/householdmembers/{caseId}/{id} - add household member to a case
* GET /api/v2/housing/householdmembers/{caseId}/{id}/check - cross validate household member

### Expense
* GET /api/v2/housing/expenses/{caseId} - fetch all expenses of a case
* GET /api/v2/housing/expenses/{caseId}/{id} - fetch one expense
* PUT /api/v2/housing/expenses/{caseId} - update expense in case
* POST /api/v2/housing/expenses/{caseId}/{id} - add expense to a case
* GET /api/v2/housing/expenses/{caseId}/{id}/check - cross validate expense

### Income
* GET /api/v2/housing/incomes/{caseId} - fetch all incomes of a case
* GET /api/v2/housing/incomes/{caseId}/{id} - fetch one income
* PUT /api/v2/housing/incomes/{caseId} - add income to a case
* POST /api/v2/housing/incomes/{caseId}/{id} - update (or add) income in a case
* GET /api/v2/housing/incomes/{caseId}/{id}/check - cross validate income

### Housing benefit application
* GET /api/v2/housing/applications/{caseId} - fetch all housing benefit applications of a case
* GET /api/v2/housing/applications/{caseId} - fetch one housing benefit application
* PUT /api/v2/housing/applications/{caseId} - update housing benefit application in a case
* POST /api/v2/housing/applications/ - add housing benefit application in a case
* GET /api/v2/housing//applications/{caseId}/{id}/check - cross validate housing benefit application

## Variations in different branches
It is worth noting that this repository contains additional branches which may be of interest. These are more straightforward or more complex software architectures with the same theme and business model, as follows:
* bottom-up: a more simple approach which doesn't utilize openapi-generator. The Rest API is hand coded, and utilizes directly the entity objects in the interface
* daolayer: a more complex approach centered in different repositories. PostgreSQL is used here, and two repository implementations are provided: a straightforward JPA-based one, and a little more exciting JPA and JSON based one. The idea with JSON columns is to be able to add attributes to business objects without having to bother with database and JPA entity changes. This does work, but repository layer adds complexity and lines of code a little.
 
In addition to the actual Rest service, there are experiments with JSON schema based validation in class JsonSchemaValidition application (in src/test/main). JSON schema files can be found in src/main/resources and some example JSON input in src/test/resources. JsonSchemaValidation app also shows how to combine JSON schema validation to Spring validation (in a rather unsatisfactory way, though). This could also be applied to Rest service, see [this blog post](https://www.mscharhag.com/spring/json-schema-validation-handlermethodargumentresolver). All in all, only quite basic validation can be done through JSON schema validation - no cross-validation can be done, and no validation containing complex logic (such as validating control characters). 
 
## Running in Openshift
This app can be deployed OpenShift environment using fabirc8. The prerequisites are as follows
* OpenShift environment is available (a local "Code ready container" or enterprise version)
* You have been logged into OpenShift ("oc login -u XXXX -p YYYYY")
* You have chosen or created an openshift project ("e.g oc new-project housing-server")
